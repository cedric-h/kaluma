#include <stdio.h>
#include <ctype.h>
#include <stdlib.h>
#include <string.h>
#include "tone_map.h"

char *examples[] = {
  "166.66666666666666,\n"
  "166.66666666666666: a4^166.66666666666666,\n"
  "5000",

  "379.746835443038: d4^379.746835443038 + c5~379.746835443038,\n"
  "379.746835443038: b4~379.746835443038 + e4^379.746835443038 + g5/379.746835443038,\n"
  "379.746835443038: c5~379.746835443038,\n"
  "379.746835443038: d5~379.746835443038 + f4^379.746835443038 + b5/379.746835443038,\n"
  "379.746835443038: e5~379.746835443038 + g5/379.746835443038,\n"
  "379.746835443038: e4^379.746835443038 + a5/379.746835443038,\n"
  "379.746835443038: d5~379.746835443038,\n"
  "379.746835443038: c5~379.746835443038 + d4^379.746835443038 + g5/379.746835443038,\n"
  "379.746835443038: b4~379.746835443038,\n"
  "379.746835443038: b5/379.746835443038,\n"
  "379.746835443038: g5/379.746835443038,\n"
  "379.746835443038: b4~379.746835443038 + f4^379.746835443038 + a5/379.746835443038,\n"
  "379.746835443038: c5~379.746835443038,\n"
  "379.746835443038: d5~379.746835443038 + e4^379.746835443038,\n"
  "379.746835443038: g5/379.746835443038,\n"
  "379.746835443038: b4~379.746835443038 + d4^379.746835443038 + b5/379.746835443038,\n"
  "379.746835443038: a4~379.746835443038 + g5/379.746835443038,\n"
  "379.746835443038: g4~379.746835443038 + c4^379.746835443038 + a5/379.746835443038,\n"
  "379.746835443038: g5/379.746835443038 + a4~379.746835443038 + d4^379.746835443038,\n"
  "379.746835443038: g4~379.746835443038,\n"
  "379.746835443038: g5/379.746835443038 + e4^379.746835443038,\n"
  "379.746835443038: a4~379.746835443038,\n"
  "379.746835443038: b5/379.746835443038 + f4^379.746835443038 + b4~379.746835443038,\n"
  "379.746835443038: g5/379.746835443038 + c5~379.746835443038,\n"
  "379.746835443038: a5/379.746835443038 + e4^379.746835443038 + d5~379.746835443038,\n"
  "379.746835443038,\n"
  "379.746835443038: d4^379.746835443038 + c5~379.746835443038,\n"
  "379.746835443038: g5/379.746835443038 + b4~379.746835443038,\n"
  "379.746835443038: c4^379.746835443038 + a4~379.746835443038,\n"
  "379.746835443038: b5/379.746835443038 + d4^379.746835443038,\n"
  "379.746835443038: g5/379.746835443038 + e4^379.746835443038 + a4~379.746835443038,\n"
  "379.746835443038: a5/379.746835443038 + f4^379.746835443038 + b4~379.746835443038",

  "166.66666666666666,\n"
  "166.66666666666666: c5-166.66666666666666,\n"
  "166.66666666666666: b4-166.66666666666666,\n"
  "4833.333333333333",

  "500,\n"
  "500: c5~500,\n"
  "500: d5~500,\n"
  "500: e5~500,\n"
  "14000",

  "166.66666666666666,\n"
  "166.66666666666666: c5~166.66666666666666,\n"
  "166.66666666666666: d5~166.66666666666666,\n"
  "166.66666666666666: e5~166.66666666666666,\n"
  "166.66666666666666: b4~166.66666666666666,\n"
  "166.66666666666666: c5~166.66666666666666,\n"
  "166.66666666666666: d5~166.66666666666666,\n"
  "166.66666666666666: e5~166.66666666666666,\n"
  "166.66666666666666: d5~166.66666666666666,\n"
  "166.66666666666666: c5~166.66666666666666,\n"
  "166.66666666666666,\n"
  "166.66666666666666: b4~166.66666666666666,\n"
  "166.66666666666666: e5~166.66666666666666,\n"
  "166.66666666666666: c5~166.66666666666666,\n"
  "3000",

  "166.66666666666666\n"
};

#define ARR_LEN(arr) (sizeof(arr) / sizeof(arr[0]))
typedef struct {
  uint8_t open;
  char *str;
} NoteReadState;

static uint8_t note_read(NoteReadState *nrs) {
  char *endptr = NULL;

  if (!nrs->open) {
    printf("pause { duration: %fms }\n", strtof(nrs->str, &endptr));
    if (endptr) {
      nrs->str = endptr;

      /* if there's more than just a pause, we open for notes */
      if (*nrs->str == ':') {
        nrs->str++; /* consume the comma! */
        nrs->open = 1;
        return 1;
      }
    }
  }
  else {
    while (1) {
      if (*nrs->str == ' ') { nrs->str++; continue; }
      if (*nrs->str == '+') { nrs->str++; continue; }
      if (*nrs->str == ',') { nrs->open = 0; break; }
      if (*nrs->str ==   0) { nrs->open = 0; break; }
      if (*nrs->str <= 'z' && *nrs->str >= 'a') {

        char note[4] = {0};
        int freq = 0;
        {
          int note_len = 0;
          while (isalnum(*nrs->str) || *nrs->str == '#')
            note[note_len++] = *nrs->str++;
          freq = tone_map[fnv1_hash(note, note_len) % ARR_LEN(tone_map)];
        }

        char shape = *nrs->str++;

        endptr = NULL;
        float duration = strtof(nrs->str, &endptr);
        if (endptr) nrs->str = endptr;

        printf("sound { note: %s, freq: %d, shape: %c, duration: %f }\n",
          note, freq, shape, duration);

        return 1;
      }
      break;
    }
  }

  return 0;
}

static uint8_t tune_parse(NoteReadState *nrs) {
  if (note_read(nrs)) return 1;

  if (!nrs->open) {
    /* if the note didn't end with a comma, your tune is done! */
    if (*nrs->str != ',') return 0;
    /* eat that comma and newline!!! */
    nrs->str += 2;
  }

  return 1;
}

int main(void) {
  NoteReadState nrs = {0};

  for (int i = 0; i < ARR_LEN(examples); i++) {
    printf("--- EXAMPLE %d ---\n", i);

    memset(&nrs, 0, sizeof(nrs));
    nrs.str = examples[i];
    do {
      printf("%ld chars left\n", strlen(examples[i]) - (nrs.str - examples[i]));
    } while (tune_parse(&nrs));
  }

  return 0;
}
